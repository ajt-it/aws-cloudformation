
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation Infrastructure Template for launching a WordPress website


Resources:

  ########## CREATE SUBNETS CIDR

  # - PUBLIC SUBNETS
  PublicSubnet1CIDR:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-west-1a
      CidrBlock: 10.0.0.0/24
      Tags:
        - Key: Name
          Value: 'p10aic-VPC public subnet 1'
      VpcId: !Ref VPC

  # - PRIVATE SUBNETS  

  PrivateSubnet2CIDR:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-west-1b
      CidrBlock: 10.0.3.0/24
      Tags:
        - Key: Name
          Value: 'p10aic-VPC private subnet 2'    
      VpcId: !Ref VPC	

  # - DATABASE SUBNETS
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS database
      DBSubnetGroupName: RDS-Subnets
      SubnetIds:
        - !Ref PrivateSubnet1CIDR
        - !Ref PrivateSubnet2CIDR       


  ########## CREATE ROUTE TABLE

  # Create Route Table 1
  PublicRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties: 
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: "p10aic-VPC public route 1"

  # Create Route Table 2
  PublicRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties: 
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: "p10aic-VPC public route 2"   



  ########## CREATE BUCKET S3 & BUCKET POLICY

  BucketS3:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: p10aic-bucket-wp


  ########## Creates Auto Scaling Group

  WebsiteAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      DesiredCapacity: 1
      MaxSize: 2
      MinSize: 1  
      TargetGroupARNs:
        - !Ref WebsiteTargetGroup


  ########## CREATE DATABASE

  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AutoMinorVersionUpgrade: true
      DBInstanceClass: db.t2.micro
      DBName: "wordpress"
      DBInstanceIdentifier: wordpress
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      Tags:
        - Key: Name
          Value: wordpress database


  ########## AUTO SCALING GROUP RULES

  WebsiteScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebsiteAutoScalingGroup
      Cooldown: '60'
      ScalingAdjustment: 1

  WebsiteScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebsiteAutoScalingGroup
      Cooldown: '60'
      ScalingAdjustment: -1


Outputs:
  VPC:
    Description: VPC - P10_AIC
    Export:
      Name: !Sub ${AWS::StackName}-VPC
    Value: !Ref VPC
